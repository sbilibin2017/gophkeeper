# Выпускной проект GophKeeper

## О проекте

GophKeeper — клиент-серверная система для безопасного хранения и управления приватной информацией пользователя, включая логины, пароли, произвольные текстовые и бинарные данные, а также данные банковских карт.

---

## Структура проекта

```
.
├── api                             # Протоколы gRPC/Protobuf для взаимодействия клиента и сервера
│   └── protos                      # Исходные .proto файлы
│       ├── login.proto             # Протокол авторизации пользователя
│       └── register.proto          # Протокол регистрации пользователя
├── cmd                             # Команды CLI-приложения
│   └── client                      # Реализация клиентского CLI-приложения
│       ├── app                     # Команды CLI (register, login, add и т.д.)
│       │   ├── add.go              # Команда добавления данных
│       │   ├── app.go              # Инициализация корневой команды приложения
│       │   ├── app_test.go         # Тесты для app.go
│       │   ├── build_info.go       # Команда для вывода информации о сборке
│       │   ├── build_info_test.go  # Тесты для команды build_info
│       │   ├── get.go              # Команда получения секретов по ключу
│       │   ├── list.go             # Команда для вывода списка секретов
│       │   ├── login.go            # Команда логина пользователя
│       │   ├── login_test.go       # Тесты для login.go
│       │   ├── register.go         # Команда регистрации пользователя
│       │   ├── register_test.go    # Тесты для register.go
│       │   └── sync.go             # Команда синхронизации данных
│       ├── main.go                 # Точка входа для CLI-приложения
│       └── main_test.go            # Интеграционные тесты для CLI (через бинарник)
├── go.mod                          # Модуль Go с зависимостями
├── go.sum                          # Контрольные суммы зависимостей
├── internal                        # Внутренние пакеты (не экспортируются наружу)
│   ├── configs                     # Работа с конфигурациями
│   │   ├── buildinfo               # Метаданные сборки
│   │   │   ├── build_info.go       # Структура и методы сборочной информации
│   │   │   └── build_info_test.go  # Тесты для build_info
│   │   ├── client.go               # Конфигурация клиента (HTTP/gRPC, ключи и т.д.)
│   │   └── client_test.go          # Тесты для client.go
│   ├── models                      # Модели данных
│   │   ├── client.go               # Модель учетных данных клиента
│   │   └── secret.go               # Модель хранимых секретов
│   └── services                    # Логика работы клиента с сервером
│       ├── login.go                # Реализация сервиса логина (HTTP/gRPC)
│       ├── login_mock.go           # Моки для login-сервиса
│       ├── login_test.go           # Тесты для login.go
│       ├── register.go             # Реализация сервиса регистрации
│       ├── register_mock.go        # Моки для register-сервиса
│       └── register_test.go        # Тесты для register.go
├── Makefile                        # Скрипты сборки и тестирования
├── pkg                             # Внешние пакеты (экспортируемые)
│   └── grpc                        # gRPC-клиенты, сгенерированные из .proto
│       ├── login_grpc.pb.go        # gRPC-клиент для login.proto
│       ├── login.pb.go             # Структуры и интерфейсы login.proto
│       ├── register_grpc.pb.go     # gRPC-клиент для register.proto
│       └── register.pb.go          # Структуры и интерфейсы register.proto
└── README.md                       # Описание проекта и инструкция по запуску
```

## Клиент

| Команда              | Флаги/Параметры                                                                                 | Описание                                                              |
|----------------------|--------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
| `client build-info`  | *(без флагов)*                                                                                   | Отображение информации о сборке клиента (версия, хэш, дата и т.п.)   |
| `client usage`       | *(без флагов)*                                                                                   | Просмотр справки по использованию клиента                             |
| `client register`    | `--server-url <url>`, `--username <имя>`, `--password <пароль>`                                  | Регистрация нового пользователя                                       |
| `client login`       | `--server-url <url>`, `--username <имя>`, `--password <пароль>`                                  | Аутентификация существующего пользователя                             |
| `client logout`      | `--server-url <url>`                                                                             | Выход из текущей сессии пользователя                                  |
| `client add`         | `--server-url <url>`, `[--file <путь_к_файлу>]`, `[--interactive]`                               | Добавление новых данных/секретов из файла или интерактивно            |
| `client get`         | `--server-url <url>`, `[--secret-id <идентификатор>]`                                            | Получение конкретных данных/секрета с сервера                         |
| `client list`        | `--server-url <url>`, `[--secret-type <тип>]`, `[--sort <ключ>]`                                 | Отображение списка сохранённых данных с фильтрацией и сортировкой     |
| `client sync`        | `--server-url <url>`, `--dry-run`, `--auto-resolve=client\|server`, `--interactive`              | Синхронизация клиента с сервером и разрешение конфликтов              |


---

### `sync`

| Шаг                         | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **1. Выявление конфликтов** | При запуске `gophkeeper sync`:<br>- Извлечение из локальной SQLite базы списка всех секретов с `ID` и `UpdatedAt`.<br>- Отправка списка на сервер.<br>- Получение актуальных версий с сервера.<br>- Сравнение локальных и серверных по `UpdatedAt`.<br>- Если есть конфликты, выводится список в терминал.<br><br>**Пример:**<br>Найдены конфликты в секретах:<br>ID: abc123, локальная версия обновлена: 2025-07-01T10:00:00Z,<br>серверная версия обновлена: 2025-07-02T09:00:00Z<br>ID: def456, локальная версия обновлена: 2025-07-03T11:00:00Z,<br>серверная версия обновлена: 2025-07-03T12:00:00Z<br><br>Для разрешения конфликтов:<br>`gophkeeper sync export-conflicts conflicts.json`<br>Редактируйте файл и выбирайте актуальные версии.<br>Затем загрузите исправленный файл:<br>`gophkeeper sync import-conflicts conflicts.json` |
| **2. Экспорт конфликтов**   | Выполнить команду:<br>`gophkeeper sync export-conflicts conflicts.json`<br>Файл `conflicts.json` содержит конфликтные секреты с локальными и серверными версиями и полем для выбора разрешённой версии.                                                                                                                                                                                                                                                                                                                                                  |
| **3. Импорт разрешённых конфликтов** | После редактирования выполнить:<br>`gophkeeper sync import-conflicts conflicts.json`<br>Клиент обновляет локальные секреты согласно выбранным версиям,<br>отправляет обновления на сервер.<br>В терминал выводится статус успешного разрешения конфликтов и синхронизации.                                                                                                                                                                                                                                                                         |
| **4. Автоматическая синхронизация без конфликтов** | Если конфликтов нет, при запуске `gophkeeper sync` происходит:<br>- Отправка локальных изменений на сервер.<br>- Получение свежих секретов с сервера.<br>- Обновление локальной базы.<br>В терминал выводится:<br>`Синхронизация успешно завершена. Обновлено X секретов.`                                                                                                                                                                                                                                              |
| **Формат файла conflicts.json** | Пользователь заполняет поле `resolved_version` для каждого секрета. Пример структуры файла:<br><pre style="white-space: pre-wrap;">[<br>  {<br>    "secret_id": "abc123",<br>    "local_version": {<br>      "stype": "login_password",<br>      "payload": { /* данные секрета */ },<br>      "updated_at": "2025-07-01T10:00:00Z"<br>    },<br>    "server_version": {<br>      "stype": "login_password",<br>      "payload": { /* данные секрета */ },<br>      "updated_at": "2025-07-02T09:00:00Z"<br>    },<br>    "resolved_version": null  // Здесь пользователь выбирает актуальную версию (local_version или server_version)<br>  }<br>]</pre> |

### Диаграмма синхронизации (sync)

```
Начало синхронизации
      │
      ▼
Получить локальные секреты с ID и UpdatedAt
      │
      ▼
Отправить список ID и UpdatedAt на сервер
      │
      ▼
Получить актуальные секреты с сервера
      │
      ▼
Сравнить UpdatedAt локальных и серверных секретов
      │
      ▼
Есть конфликты?
   ┌───────┴────────┐
   │                │
  Нет              Да
   │                │
   ▼                ▼
Отправить локальные  Вывести список
изменения на сервер  конфликтов в терминал
   │                │
   ▼                ▼
Получить свежие     Пользователь
секреты с сервера   разрешает конфликты:
   │                - экспортирует conflicts.json
   ▼                - редактирует файл
Вывести сообщение     - импортирует исправленный файл
об успешной синхронизации
   │                │
   ▼                ▼
  Конец          Обновить локальную
                   базу и сервер
                      │
                      ▼
              Вывести сообщение
              об успешном разрешении
              конфликтов
                      │
                      ▼
                    Конец
```

---

### Диаграмма базы данных

```
┌────────────────────┐
│   secret_types     │
├────────────────────┤
│ type_id (PK)       │
│ name               │
│ updated_at         │
└─────────┬──────────┘
          │
          │ FK (type_id)
          ▼
┌────────────────────┐
│      secrets       │
├────────────────────┤
│ secret_id (PK)     │
│ type_id (FK)       │
│ owner_id           │
│ updated_at         │
└─────────┬──────────┘
          │ 1-to-1 (secret_id)
          ▼
  ┌────────────────────────┐
  │    login_passwords     │
  ├────────────────────────┤
  │ secret_id (PK, FK)     │
  │ login                  │
  │ password               │
  │ meta                   │
  └────────────────────────┘

  ┌────────────────────────┐
  │     texts              │
  ├────────────────────────┤
  │ secret_id (PK, FK)     │
  │ content                │
  │ meta                   │
  └────────────────────────┘

  ┌────────────────────────┐
  │    binaries            │
  ├────────────────────────┤
  │ secret_id (PK, FK)     │
  │ data                   │
  │ meta                   │
  └────────────────────────┘

  ┌────────────────────────┐
  │     cards              │
  ├────────────────────────┤
  │ secret_id (PK, FK)     │
  │ number                 │
  │ holder                 │
  │ exp_month              │
  │ exp_year               │
  │ cvv                    │
  │ meta                   │
  └────────────────────────┘
```


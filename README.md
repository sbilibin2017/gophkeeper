# Выпускной проект GophKeeper

## О проекте

GophKeeper — клиент-серверная система для безопасного хранения и управления приватной информацией пользователя, включая логины, пароли, произвольные текстовые и бинарные данные, а также данные банковских карт.

---

## Структура проекта

```
.
├── api                             # Протоколы gRPC/Protobuf для взаимодействия клиента и сервера
│   └── protos                      # Исходные .proto файлы
│       ├── add.proto               # Протокол добавления данных
│       ├── login.proto             # Протокол авторизации пользователя
│       └── register.proto          # Протокол регистрации пользователя
├── cmd                             # Команды CLI-приложения
│   └── client                      # Клиентское CLI-приложение
│       ├── app                     # Команды CLI (add, get, list, login, register, sync и др.)
│       │   ├── add.go              # Команда добавления данных
│       │   ├── app.go              # Инициализация корневой команды приложения
│       │   ├── app_test.go         # Тесты для app.go
│       │   ├── build_info.go       # Команда вывода информации о сборке
│       │   ├── get.go              # Команда получения данных
│       │   ├── list.go             # Команда для вывода списка данных
│       │   ├── login.go            # Команда логина пользователя
│       │   ├── register.go         # Команда регистрации пользователя
│       │   └── sync.go             # Команда синхронизации данных
│       ├── main.go                 # Точка входа CLI-приложения
│       └── main_test.go            # Интеграционные тесты CLI
├── go.mod                          # Модуль Go с зависимостями
├── go.sum                          # Контрольные суммы зависимостей
├── internal                        # Внутренние пакеты (не экспортируются наружу)
│   ├── configs                     # Конфигурация приложения
│   │   ├── buildinfo               # Метаданные сборки
│   │   │   ├── build_info.go       # Структура и методы сборочной информации
│   │   │   └── build_info_test.go  # Тесты для build_info
│   │   ├── client.go               # Конфигурация клиента (настройки, ключи и т.п.)
│   │   ├── client_test.go          # Тесты для client.go
│   │   └── db                     # Работа с базой данных
│   │       ├── db.go              # Подключение и работа с БД
│   │       └── db_test.go         # Тесты для db.go
│   ├── models                      # Модели данных и сущности
│   │   ├── secret.go               # Модель секретов
│   │   ├── secret_test.go          # Тесты для secret.go
│   │   ├── user.go                 # Модель пользователя
│   │   └── user_test.go            # Тесты для user.go
│   └── services                   # Сервисы с бизнес-логикой
│       ├── add.go                 # Сервис добавления данных
│       ├── add_test.go            # Тесты для add.go
│       ├── login.go               # Сервис логина
│       ├── login_test.go          # Тесты для login.go
│       ├── register.go            # Сервис регистрации
│       └── register_test.go       # Тесты для register.go
├── Makefile                       # Скрипты для сборки и тестирования
├── pkg                            # Внешние (экспортируемые) пакеты
│   └── grpc                       # Сгенерированные gRPC клиенты и структуры
│       ├── add_grpc.pb.go         # gRPC клиент add.proto
│       ├── add.pb.go              # Структуры и интерфейсы add.proto
│       ├── login_grpc.pb.go       # gRPC клиент login.proto
│       ├── login.pb.go            # Структуры и интерфейсы login.proto
│       ├── register_grpc.pb.go    # gRPC клиент register.proto
│       └── register.pb.go         # Структуры и интерфейсы register.proto
└── README.md                      # Описание проекта и инструкции по запуску
```

## Клиент

| Команда              | Флаги/Параметры                                                                                 | Описание                                                              |
|----------------------|--------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
| `client build-info`  | *(без флагов)*                                                                                   | Отображение информации о сборке клиента (версия, хэш, дата и т.п.)   |
| `client usage`       | *(без флагов)*                                                                                   | Просмотр справки по использованию клиента                             |
| `client configure`   | `--token <jwt token>`                                                                            | Конфигурация клиента с установкой JWT токена                          |
| `client register`    | `--server-url <url>`, `--username <имя>`, `--password <пароль>`                                  | Регистрация нового пользователя                                       |
| `client login`       | `--server-url <url>`, `--username <имя>`, `--password <пароль>`                                  | Аутентификация существующего пользователя                             |
| `client add`         | `--server-url <url>`, `[--file <путь_к_файлу>]`, `[--interactive]`                               | Добавление новых данных/секретов из файла или интерактивно            |
| `client get`         | `--server-url <url>`, `[--secret-id <идентификатор>]`                                            | Получение конкретных данных/секрета с сервера                         |
| `client list`        | `--server-url <url>`, `[--type <тип>]`,                                  | Отображение списка сохранённых данных с фильтрацией и сортировкой     |
| `client sync`        | `--server-url <url>`, `--dry-run`, `--auto-resolve=client\|server`, `--interactive`              | Синхронизация клиента с сервером и разрешение конфликтов              |


---

### `sync`

| Шаг                         | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **1. Выявление конфликтов** | При запуске `gophkeeper sync`:<br>- Извлечение из локальной SQLite базы списка всех секретов с `ID` и `UpdatedAt`.<br>- Отправка списка на сервер.<br>- Получение актуальных версий с сервера.<br>- Сравнение локальных и серверных по `UpdatedAt`.<br>- Если есть конфликты, выводится список в терминал.<br><br>**Пример:**<br>Найдены конфликты в секретах:<br>ID: abc123, локальная версия обновлена: 2025-07-01T10:00:00Z,<br>серверная версия обновлена: 2025-07-02T09:00:00Z<br>ID: def456, локальная версия обновлена: 2025-07-03T11:00:00Z,<br>серверная версия обновлена: 2025-07-03T12:00:00Z<br><br>Для разрешения конфликтов:<br>`gophkeeper sync export-conflicts conflicts.json`<br>Редактируйте файл и выбирайте актуальные версии.<br>Затем загрузите исправленный файл:<br>`gophkeeper sync import-conflicts conflicts.json` |
| **2. Экспорт конфликтов**   | Выполнить команду:<br>`gophkeeper sync export-conflicts conflicts.json`<br>Файл `conflicts.json` содержит конфликтные секреты с локальными и серверными версиями и полем для выбора разрешённой версии.                                                                                                                                                                                                                                                                                                                                                  |
| **3. Импорт разрешённых конфликтов** | После редактирования выполнить:<br>`gophkeeper sync import-conflicts conflicts.json`<br>Клиент обновляет локальные секреты согласно выбранным версиям,<br>отправляет обновления на сервер.<br>В терминал выводится статус успешного разрешения конфликтов и синхронизации.                                                                                                                                                                                                                                                                         |
| **4. Автоматическая синхронизация без конфликтов** | Если конфликтов нет, при запуске `gophkeeper sync` происходит:<br>- Отправка локальных изменений на сервер.<br>- Получение свежих секретов с сервера.<br>- Обновление локальной базы.<br>В терминал выводится:<br>`Синхронизация успешно завершена. Обновлено X секретов.`                                                                                                                                                                                                                                              |
| **Формат файла conflicts.json** | Пользователь заполняет поле `resolved_version` для каждого секрета. Пример структуры файла:<br><pre style="white-space: pre-wrap;">[<br>  {<br>    "secret_id": "abc123",<br>    "local_version": {<br>      "stype": "login_password",<br>      "payload": { /* данные секрета */ },<br>      "updated_at": "2025-07-01T10:00:00Z"<br>    },<br>    "server_version": {<br>      "stype": "login_password",<br>      "payload": { /* данные секрета */ },<br>      "updated_at": "2025-07-02T09:00:00Z"<br>    },<br>    "resolved_version": null  // Здесь пользователь выбирает актуальную версию (local_version или server_version)<br>  }<br>]</pre> |

### Диаграмма синхронизации (sync)

```
Начало синхронизации
      │
      ▼
Получить локальные секреты с ID и UpdatedAt
      │
      ▼
Отправить список ID и UpdatedAt на сервер
      │
      ▼
Получить актуальные секреты с сервера
      │
      ▼
Сравнить UpdatedAt локальных и серверных секретов
      │
      ▼
Есть конфликты?
   ┌───────┴────────┐
   │                │
  Нет              Да
   │                │
   ▼                ▼
Отправить локальные  Вывести список
изменения на сервер  конфликтов в терминал
   │                │
   ▼                ▼
Получить свежие     Пользователь
секреты с сервера   разрешает конфликты:
   │                - экспортирует conflicts.json
   ▼                - редактирует файл
Вывести сообщение     - импортирует исправленный файл
об успешной синхронизации
   │                │
   ▼                ▼
  Конец          Обновить локальную
                   базу и сервер
                      │
                      ▼
              Вывести сообщение
              об успешном разрешении
              конфликтов
                      │
                      ▼
                    Конец
```

---



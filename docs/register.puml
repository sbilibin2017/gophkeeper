@startuml
actor Client
participant "API Server" as Server
participant RSA
participant JWT
participant "UserReadRepository" as UserRead
participant "UserWriteRepository" as UserWrite
participant "DeviceWriteRepository" as DeviceWrite

Client -> Server: POST /register {username, password}

Server -> Server: Валидация username и password

Server -> UserRead: Get(username)
UserRead --> Server: Результат проверки

Server -> RSA: GenerateRSAKeyPair()
RSA --> Server: KeyPair {PrivateKey, PublicKey}

Server -> UserWrite: Save(username, hashed_password)
UserWrite --> Server: user_id

Server -> DeviceWrite: Save(user_id, public_key)
DeviceWrite --> Server: device_id

Server -> JWT: GenerateToken({user_id, device_id})
JWT --> Server: token

Server --> Client: {user_id, device_id, token, PrivateKey}
@enduml
